<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Broker - The Things Network</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>
        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">The Things Network</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Overview</a>
                </li>
            
            
            
                <li >
                    <a href="../common/">Common</a>
                </li>
            
            
            
                <li >
                    <a href="../router/">Router</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Broker</a>
                </li>
            
            
            
                <li >
                    <a href="../networkserver/">Network Server</a>
                </li>
            
            
            
                <li >
                    <a href="../handler/">Handler</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../router/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../networkserver/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    
    <table>
        <tr><td>version:</td><td>1.0.0</td></tr>
        <tr><td>status:</td><td>draft</td></tr>
        <tr><td>lead:</td><td>Matthias Benkort</td></tr>
        <tr><td>collaborators:</td><td>
            
                Johan Stokking<br/>
            
                Hylke Visser<br/>
            
                Thomas Telkamp<br/>
            
        </td></tr>
    </table>

    <hr/>
    

    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#broker">Broker</a></li>
        
            <li><a href="#role">Role</a></li>
        
            <li><a href="#interfaces">Interfaces</a></li>
        
            <li><a href="#flow-chart">Flow Chart</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="broker">Broker</h1>
<h2 id="role">Role</h2>
<p>Brokers constitute the heart of the network. They hold the logic that makes every other
component work together (routers, network servers and handlers). They play a role of mediator,
making sure that packets are correct and handling communications between other components. To
each broker is associated a given network server with which it is working closely. We can see
the network server as external ressources of computing and storage to which a broker could
refer at any time. </p>
<p>Therefore, a broker is in charge of a set of nodes. This is a 1-to-1 relation meaning that a
node is controlled by a unique broker. There is for the moment no duplication or sharing
possible. A broker does not have access to network servers different from the one it has been
assigned. A node isn't shared and all packets coming from a given node end to the same
given broker.</p>
<p>Besides, a broker does not know any router by advance. The process is seemingly similar to the way
gateways and routers are getting to know each others. A router will initiate a communication
toward a broker. After dealing with the communication, the broker may reply to the router and
will forget about its existence. Brokers are known from routers, like routers are
known from gateways. </p>
<p>On the other hand, brokers communicate with a bunch of handlers that have registered themselves
beforehand. This way, when a device joins the network every broker has to communicate with its
own handlers list to determine wether or not it has to handle packets incoming from that
device. The previous assertion assumes that a given handler isn't registered to several
 brokers. </p>
<p>Relations are schematically represented in the next diagram. </p>
<hr />
<p><img alt="Broker's relations" src="../img/broker_relations.svg" />
<p align="center"><em>Broker's relations</em></p></p>
<hr />
<p>For each node it is in charge of, the broker holds a network session key associated to the node.
It is thereby able to check the integrity of the packet by doing a <code>MIC check</code>. The process is
detailed in the <a href="https://www.lora-alliance.org/portals/0/specs/LoRaWAN%20Specification%201R0.pdf">LoRaWAN specifications</a> - section 4.4 Message Integrity Code (MIC). </p>
<p>Depending of the packet's nature, the broker might communicate with either its network server
or a registered handler. Part of the packet's message contains a <em>MAC header</em> <code>MHDR</code> which is
not encrypted and gives details about the packet's nature (cf the <a href="../img/cheatsheet.svg">payload
cheatsheet</a>). Thus, for any command (<code>FPort</code> set to <code>0</code>) the broker would
forward the action to its network server. Otherwise, the packet is forwarded to the right
handler. </p>
<h3 id="uplink-transmissions">Uplink transmissions</h3>
<p>The broker is waiting for router to forward packets coming from nodes. When receiving a packet,
the broker should firstly check wether or not it should take care of the packet. This is done
by looking into a local storage of node addresses. This is list of addresses is created
dynamically during the broker's lifecycle as long as handlers register to the broker. 
Then, because collisions may happen between node adresses, the broker also has to perform a
<code>MIC check</code> to ensure both the validity and its responsability for the given packet. </p>
<p>An unknown address or a invalid <code>MIC check</code> should lead to an error transmitted to the router
emitter. Errors are detailed in a next section. If everything went well, the broker has to
decode the packet <code>MAC header - MHDR</code> and determine wether the packet carry a command or data.
The broker's behavior is thereby slightly different regarding to the packet's content. </p>
<p><strong>Packet with commands</strong></p>
<p>For any received command, the broker will forward the packet to the network server able to deal
with the command. A command is completely invisible to the application (and thus, handlers). By
the by, when forwarding a command to a network server, the broker might wait for an answer
until a timeout delay is reached (after the second receive window is missed for instance).</p>
<p><strong>Packet with data</strong></p>
<p>When the packet is carrying data towards an application, it should be forwarded to the right
handler. In a similar way of what is done with commands, the broker will also wait for an
answer to reply to the router. 
In the meantime, a broker will notify its network server that a receive window for the given
device is available. The network server should either reply by a command to send back, or deny
the offer. </p>
<p>Once both the network server and the handler have replied, the broker has to merge the response
into one single packet and send it back to the router (if necessary, it could happen that the
request does not need any packet to be sent as answer).</p>
<p><strong>Join request</strong></p>
<p>A special edge-case requires an additional behavior. Join request might be sent from a device,
in which case, the handler has to be contacted as a referee in order to authorize or reject the
willing node. In case of success, the network server should be notified in order to setup and
initialize the node managing in the future. </p>
<h2 id="interfaces">Interfaces</h2>
<p>In order to communicate with other components, a broker will be split in four parts:</p>
<ul>
<li>The core broker</li>
<li>The router adapter</li>
<li>The handler adapter</li>
<li>The network server adapter</li>
</ul>
<p>The idea is to avoid to tightly couple the broker core features with the way it is
communicating. By doing such a separation of concerns, we allow the broker to evolve and change
its communication protocols at any moment without any impact on the core mechanisms. Thus, as
long as the adapters remain compliant to a given interface, they can be switched on demand. </p>
<p>We previously identified the communication needs between the broker and other components.
Incidentally, all adapters and the core broker are sharing a same packet structure (see
<a href="../common">Common</a> for more details).</p>
<h3 id="the-router-adapter">The router adapter</h3>
<p>We consider the following methods for the Router adapter (hereby known as <code>RoutAdapter</code>):</p>
<pre><code class="haskell">-- Reject a packet previously received by the broker
reject :: RoutAdapter, Packet -&gt; Unit

-- Notify routers that the given packet has been received and is handled
ack :: RoutAdapter, Packet -&gt; Unit 

-- Send a packet as response to a router
forward :: RoutAdapter, Packet -&gt; Unit
</code></pre>

<h3 id="the-handler-adapter">The handler adapter</h3>
<p>We consider the following methods for the Handler adapter (hereby known as <code>HandAdapter</code>):</p>
<pre><code class="haskell">--  Forward a join request to the handler
join :: HandAdapter, HandAddr, Packet -&gt; Unit 

-- Forward data to the handler
forward :: HandAdapter, HandAddr, Packet -&gt; Unit
</code></pre>

<h3 id="the-network-server-adapter">The network server adapter</h3>
<p>We consider the following methods for the Network Server adapter (hereby known as <code>NSAdapter</code>):</p>
<pre><code class="haskell">-- Forward a command to the Network Server. 
command :: NSAdapter, Packet -&gt; Command
</code></pre>

<h3 id="the-core-broker">The core broker</h3>
<p>We consider the following methods for the Core Broker (hereby kown as <code>Broker</code>): </p>
<pre><code class="haskell">-- Handle an error thrown by an adapter
handleError :: Broker, Error -&gt; Unit

-- Handle an incoming packet from the router
handleUplink :: Broker, Packet -&gt; Unit

-- Handle an incoming packet from the handler
handleData :: Broker, DevAddr, Data -&gt; Unit

-- Handle an incoming command from the Network Server
HandleCommand :: Broker, DevAddr, Command -&gt; Unit

-- Receive and store a network session key associated to a device
HandleNwkSKey :: Broker, DevAdrr, NwkSKey -&gt; Unit

</code></pre>

<h2 id="flow-chart">Flow Chart</h2>
<p>//TODO</p></div>
        </div>

        
        <div id="disqus_thread" class="container"></div>
        <script type="text/javascript">
            var disqus_shortname = 'thethingsnetwork';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>